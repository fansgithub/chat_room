<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>欢迎来到很low的聊天室</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="./bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
    <script src="./js/jquery-1.12.3.min.js"></script>
    <script src="./bootstrap-3.3.5/js/bootstrap.min.js"></script>
    <script>
        window.onload = function(){
            //发送接口获取用户信息
            // var userInfo;
            // $.ajax({
            //     url: '/user-info',
            //     type: 'GET',
            //     success: function(data){
            //         userInfo = data;
            //         $('#welcome').text(`${userInfo.user_nick_name}，欢迎回来！`);
            //         createConnect();
            //     },
            //     error: function(err){
            //         console.log(err)
            //     }
            // })
            createConnect();
            function createConnect(){
                //建立连接
                var ws = new WebSocket("ws://192.168.10.24:8181");
                //ws.user_nick_name = userInfo.user_nick_name;
                ws.onopen = function (e) {
                    // ws.send(JSON.stringify({
                    //     source: userInfo.user_nick_name,
                    //     type: 'system',
                    //     message: userInfo.user_nick_name + '已连接'
                    // }));
                }
                //收到消息处理
                ws.onmessage = function (e) {
                    var data = JSON.parse(e.data);
                    appendLog(data.source, data.message);
                }
                ws.onclose = function (e) {
                    // ws.send(JSON.stringify({
                    //     source: userInfo.user_nick_name,
                    //     type: 'system',
                    //     message: userInfo.user_nick_name + '已断开'
                    // }));
                }
                 //发送消息
                let sendBtn = document.getElementById('send');
                $('#send').on('click', function(){
                    var messageField = document.getElementById('text');
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            source: userInfo.user_nick_name,
                            type: 'personal',
                            message: messageField.value
                        }));
                    }
                    messageField.value = '';
                    messageField.focus();
                })
            }
           
            //显示
            function appendLog(source, message) {
                var messages = document.getElementById('messages');
                var messageElem = document.createElement("li");
                var preface_label
                if(source === 'system'){
                    //系统消息
                    preface_label = "<span class=\"label label-info\">System</span>";
                    
                }else{
                    preface_label = "<span class=\"label label-info\">"+ source + "</span>";
                }
                var message_text = "<h2>" + preface_label + "&nbsp;&nbsp;"
                    + message + "</h2>";
                    messageElem.innerHTML = message_text;
                    messages.appendChild(messageElem);
            }
        }
       
    </script>
</head>
<body>
    <h1 id="welcome"></h1>
    <ul id="messages"></ul>
    <input type="text" id="text" />
    <button id="send">send</button>
</body>
</html>